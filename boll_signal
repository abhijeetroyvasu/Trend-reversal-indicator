//@version=4
study (shorttitle="atr", title="Bollinger Bands", overlay=true)
length = input(20, minval=1)
src = input(close, title="Source")
mult = input(2.0, minval=0.001, maxval=50, title="StdDev")
basis = sma(src, length)
dev2 = mult * stdev(src, length)
upper = basis + dev2
lower = basis - dev2
offset = input(0, "Offset", minval = -500, maxval = 500)
plot(basis, "Basis", color=#FF6D00, offset = offset)
p1 = plot(upper, "Upper", color=#2962FF, offset = offset)
p2 = plot(lower, "Lower", color=#2962FF, offset = offset)
fill(p1, p2, title = "Background", color=color.rgb(33, 150, 243, 95))
src2 = close
out2 = ema(close, 200)
out20 = ema(close, 5)
up2 = out2 > out2[1]
down2 = out2 < out2[1]
mycolor2 = up2 ? #1EA061 : down2 ? #C00C00 : #A0594E
// mycolor2 = up2 ? green : down2 ? red : blue
bool longsignal = (high < out20)
bool shortsignal = (low > out20)
plotshape(longsignal, "Long", shape.triangleup, location.belowbar,color.blue ,text="𝗕𝗨𝗬" )
// plotchar(longsignal, "Long", char='B')
// barcolor(longsignal ? color.yellow : shortsignal ? color.aqua : na)
plotshape(shortsignal ,"short",shape.triangledown, location.abovebar,color.red , text="𝗦𝗘𝗟𝗟")
// plotchar(shortsignal ,"short", char='S')
//@version=4
// study("Average low/high",  overlay = false)

// period = input(20, "Period")
//   percentHL = ((high-low)/low)*10000
// percentRed = open>close? ((open-close)/close)*100 :0
// percentGreen = open<close? ((close-open)/open)*100 :0
// avgHL = sma(percentHL, period)
// Bcolor = open>close? color.red:color.green
//  plot(percentHL, style=box ,color=color.black)
// plot(percentGreen, style=plot.style_columns, color=color.orange)
// plot(percentRed, style=plot.style_columns, color=color.orange)
// plot(avgHL, color=color.blue, linewidth=2)
plot(out2, title="SMA",color=mycolor2, linewidth=2)
plot(out20,linewidth=2)
// study("HalfTrend", overlay=true)

amplitude = input(title="Amplitude", defval=2)
channelDeviation = input(title="Channel Deviation", defval=2)
showArrows = input(title="Show Arrows", defval=true)
showChannels = input(title="Show Channels", defval=true)

var int trend = 0
var int nextTrend = 0
var float maxLowPrice = nz(low[1], low)
var float minHighPrice = nz(high[1], high)

var float up = 0.0
var float down = 0.0
float atrHigh = 0.0
float atrLow = 0.0
float arrowUp = na
float arrowDown = na

atr2 = atr(100) / 2
dev = channelDeviation * atr2

highPrice = high[abs(highestbars(amplitude))]
lowPrice = low[abs(lowestbars(amplitude))]
highma = sma(high, amplitude)
lowma = sma(low, amplitude)

if nextTrend == 1
	maxLowPrice := max(lowPrice, maxLowPrice)

	if highma < maxLowPrice and close < nz(low[1], low)
		trend := 1
		nextTrend := 0
		minHighPrice := highPrice
else
	minHighPrice := min(highPrice, minHighPrice)

	if lowma > minHighPrice and close > nz(high[1], high)
		trend := 0
		nextTrend := 1
		maxLowPrice := lowPrice

if trend == 0
	if not na(trend[1]) and trend[1] != 0
		up := na(down[1]) ? down : down[1]
		arrowUp := up - atr2
	else
		up := na(up[1]) ? maxLowPrice : max(maxLowPrice, up[1])
	atrHigh := up + dev
	atrLow := up - dev
else
	if not na(trend[1]) and trend[1] != 1 
		down := na(up[1]) ? up : up[1]
		arrowDown := down + atr2
	else
		down := na(down[1]) ? minHighPrice : min(minHighPrice, down[1])
	atrHigh := down + dev
	atrLow := down - dev

ht = trend == 0 ? up : down

var color buyColor = color.blue
var color sellColor = color.red

htColor = trend == 0 ? buyColor : sellColor
htPlot = plot(ht, title="HalfTrend", linewidth=2, color=htColor)

atrHighPlot = plot(showChannels ? atrHigh : na, title="ATR High", style=plot.style_circles, color=sellColor)
atrLowPlot = plot(showChannels ? atrLow : na, title="ATR Low", style=plot.style_circles, color=buyColor)

fill(htPlot, atrHighPlot, title="ATR High Ribbon", color=sellColor)
fill(htPlot, atrLowPlot, title="ATR Low Ribbon", color=buyColor)

buySignal = not na(arrowUp) and (trend == 0 and trend[1] == 1)
sellSignal = not na(arrowDown) and (trend == 1 and trend[1] == 0)

plotshape(showArrows and buySignal ? atrLow : na, title="Arrow Up", style=shape.triangleup, location=location.absolute, size=size.tiny, color=buyColor)
plotshape(showArrows and sellSignal ? atrHigh : na, title="Arrow Down", style=shape.triangledown, location=location.absolute, size=size.tiny, color=sellColor)

alertcondition(buySignal, title="Alert: HalfTrend Buy", message="HalfTrend Buy")
alertcondition(sellSignal, title="Alert: HalfTrend Sell", message="HalfTrend Sell")
